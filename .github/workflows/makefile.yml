name: Build RK3288 M2 Android 9 ROM (LineageOS 16.0)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest  # Ubuntu 24.04 - handles 32-bit deps correctly
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install Dependencies (Ubuntu 24.04 Fix)
      run: |
        sudo apt update
        sudo apt install -y \
          git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev \
          gcc-multilib g++-multilib libc6-dev-i386 \
          libncurses5:i386 lib32ncurses-dev lib32z1-dev lib32bz2-dev \
          x11proto-core-dev libx11-dev:i386 libgl1-mesa-dev \
          libxml2-utils xsltproc unzip fontconfig python3 openjdk-8-jdk repo bc bison flex libssl-dev

    - name: Set Up Repo Tool
      run: |
        mkdir -p ~/.bin
        PATH="${PATH}:~/.bin"
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+x ~/.bin/repo

    - name: Cache LineageOS Repo
      uses: actions/cache@v4
      with:
        path: |
          .repo
          out
        key: lineage-16.0-${{ hashFiles('**/*.xml') }}

    - name: Initialize & Sync LineageOS 16.0
      run: |
        repo init -u https://github.com/LineageOS/android.git -b lineage-16.0
        repo sync -c -j$(nproc) --force-sync

    - name: Build Kernel with Custom DTS
      run: |
        git clone https://github.com/rockchip-linux/kernel.git -b develop-4.4 kernel
        cd kernel
        # Copy your files (assume committed)
        cp ../device/rockchip/rk3288_m2/rk3288_m2_defconfig arch/arm/configs/
        cp ../device/rockchip/rk3288_m2/rk3288-m2.dts arch/arm/boot/dts/
        sed -i '/dtb-$(CONFIG_ARCH_ROCKCHIP)/a dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3288-m2.dtb' arch/arm/boot/dts/Makefile
        make rk3288_m2_defconfig
        make -j$(nproc) zImage dtbs modules

    - name: Set Up Device Configs
      run: |
        cp kernel/arch/arm/boot/zImage device/rockchip/rk3288_m2/prebuilt/zImage
        cp kernel/arch/arm/boot/dts/rk3288-m2.dtb device/rockchip/rk3288_m2/prebuilt/dt.img
        cp kernel/drivers/net/wireless/bcmdhd/brcmfmac/brcmfmac.ko device/rockchip/rk3288_m2/prebuilt/modules/ || true  # If path varies

    - name: Build ROM
      run: |
        source build/envsetup.sh
        lunch lineage_rk3288_m2-userdebug
        mka bacon -j$(nproc)

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: M2_Lineage9_ROM
        path: |
          out/target/product/rk3288_m2/*.zip
          out/target/product/rk3288_m2/*.img

    - name: Release to GitHub
      uses: softprops/action-gh-release@v2
      if: github.ref == 'refs/heads/main'
      with:
        files: out/target/product/rk3288_m2/*.zip
        tag_name: v9.0-${{ github.run_number }}
        name: LineageOS 16.0 for RK3288 M2 (Build ${{ github.run_number }})
        body: "Android 9 ROM with WiFi/Display fixes. Flash via AndroidTool."
