name: Build RK3288 M2 Android 9 ROM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # Critical: More disk headroom + legacy i386 packages
    timeout-minutes: 360
    steps:

    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Free Disk Space (Clean Runner)
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/lib/jvm/*
        df -h

    - name: Install Dependencies (Ubuntu 22.04 Final Fix)
      run: |
        # Step 1: Enable i386 architecture
        sudo dpkg --add-architecture i386
        sudo apt update

        # Step 2: Enable universe repo (for libncurses5:i386, libbz2-1.0:i386)
        sudo add-apt-repository universe -y
        sudo apt update

        # Step 3: Install all required packages (verified in 22.04)
        sudo apt install -y \
          git repo python3 openjdk-8-jdk bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf imagemagick \
          lib32ncurses5-dev lib32readline-dev lib32z1-dev \
          liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
          lzop pngcrush schedtool squashfs-tools xsltproc zip zlib1g-dev \
          libbz2-dev \
          libncurses5:i386 libbz2-1.0:i386

    - name: Set Up Repo Tool
      run: |
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+x ~/.bin/repo
        export PATH="$PATH:~/.bin"

    - name: Cache Repo Projects (Shallow Sync)
      id: cache-repo
      uses: actions/cache@v4
      with:
        path: .repo/projects/**
        key: repo-projects-${{ hashFiles('device/**', 'kernel/**') }}
        restore-keys: repo-projects-

    - name: Initialize & Shallow Sync LineageOS 16.0
      run: |
        repo init -u https://github.com/LineageOS/android.git -b lineage-16.0 --depth 1
        repo sync -c -j4 --no-clone-bundle --optimized-fetch --prune
        # Only sync what we need
        mkdir -p .repo/local_manifests
        cat << 'EOF' > .repo/local_manifests/roomservice.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remove-project name="LineageOS/android_packages_apps_Trebuchet" />
          <remove-project name="LineageOS/android_packages_apps_Launcher3" />
        </manifest>
        EOF
        repo sync -j4

    - name: Build Kernel
      run: |
        git clone --depth 1 https://github.com/rockchip-linux/kernel.git -b develop-4.4 kernel
        cd kernel
        cp ../device/rockchip/rk3288_m2/rk3288_m2_defconfig arch/arm/configs/
        cp ../device/rockchip/rk3288_m2/rk3288-m2.dts arch/arm/boot/dts/
        sed -i '/dtb-$(CONFIG_ARCH_ROCKCHIP)/a dtb-$(CONFIG_ARCH_ROCKCHIP) += rk3288-m2.dtb' arch/arm/boot/dts/Makefile
        make rk3288_m2_defconfig
        make -j4 zImage dtbs modules

    - name: Copy Kernel Outputs
      run: |
        mkdir -p device/rockchip/rk3288_m2/prebuilt
        cp kernel/arch/arm/boot/zImage device/rockchip/rk3288_m2/prebuilt/
        cp kernel/arch/arm/boot/dts/rk3288-m2.dtb device/rockchip/rk3288_m2/prebuilt/dt.img
        mkdir -p device/rockchip/rk3288_m2/prebuilt/modules
        find kernel -name "brcmfmac.ko" -exec cp {} device/rockchip/rk3288_m2/prebuilt/modules/ \; || true

    - name: Build ROM (Minimal)
      run: |
        source build/envsetup.sh
        lunch lineage_rk3288_m2-userdebug
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        export CCACHE_MAXSIZE=50G
        ccache -M 50G
        mka bacon -j4

    - name: Upload ROM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: M2_Lineage9_ROM
        path: |
          out/target/product/rk3288_m2/lineage-*.zip
          out/target/product/rk3288_m2/boot.img
          out/target/product/rk3288_m2/system.img
        retention-days: 7

    - name: Cleanup (Free Space)
      if: always()
      run: |
        sudo rm -rf kernel .repo out
        df -h
